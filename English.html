<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem RPH — Bahasa Inggeris (Print-Safe)</title>
  <style>
    :root{
      --brand:#1d4ed8;
      --brand-light:#60a5fa;
      --ink:#111827;
      --muted:#6b7280;
      --panel:#ffffff;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      margin:0; background:#f3f4f6; color:var(--ink);
      line-height:1.6;
    }
    header{
      background:linear-gradient(135deg,var(--brand),var(--brand-light));
      color:#fff; padding:28px 16px; text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    header h1{margin:0 0 6px;font-weight:700;font-size:1.8rem}
    header p{margin:0;opacity:.95;font-size:1rem}
    main{max-width:1100px;margin:20px auto;padding:0 16px 50px}
    .card{
      background:var(--panel); border:1px solid var(--line);
      border-radius:14px; padding:22px;
      box-shadow:0 6px 24px rgba(0,0,0,.06);
    }
    .row{display:flex;flex-wrap:wrap;gap:16px}
    .row > *{flex:1 1 220px}
    label{font-weight:600;color:var(--muted);font-size:.95rem;display:block;margin-bottom:4px}
    select, input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--line);
      border-radius:10px; background:#fff; font-size:14px;
      transition:border-color .2s, box-shadow .2s;
    }
    select:focus, input[type="text"]:focus{
      border-color:var(--brand); box-shadow:0 0 0 2px rgba(29,78,216,.15);
      outline:none;
    }
    table{
      width:100%; border-collapse:collapse; margin-top:10px; background:#fff;
      border:1px solid var(--line); border-radius:10px; overflow:hidden;
    }
    th, td{padding:10px 12px; border-bottom:1px solid var(--line); text-align:left}
    th{background:#f9fafb;font-weight:700;color:var(--ink)}
    tr:last-child td{border-bottom:none}
    .btn{
      display:inline-block; padding:10px 16px; border-radius:10px; border:1px solid transparent;
      background:var(--brand); color:#fff; cursor:pointer; font-weight:600;
      box-shadow:0 4px 12px rgba(29,78,216,.3); transition:.15s;
    }
    .btn.secondary{background:#0284c7}
    .btn.ghost{background:#fff;color:var(--brand);border-color:var(--brand);box-shadow:none}
    .btn:hover{transform:translateY(-1px);}
    .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:14px}
    #output{margin-top:22px}

    .rph{
      background:#fff; border:1px solid var(--line); border-radius:14px;
      padding:22px 22px 16px; margin:18px 0; box-shadow:0 4px 14px rgba(0,0,0,.06);
      page-break-after:always;
    }
    .rph-header{
      display:grid; grid-template-columns:1fr 1fr; gap:8px 16px; align-items:center;
      border-bottom:2px solid var(--line); padding-bottom:12px; margin-bottom:12px;
    }
    .rph-title{font-size:1.15rem; font-weight:800; letter-spacing:.3px;color:var(--brand)}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:2px 10px; font-size:.94rem}
    .kv b{color:var(--ink)}
    .section{margin-top:12px;}
    .section h4{
      margin:12px 0 6px; font-size:1rem; color:var(--ink); position:relative; padding-left:12px;
    }
    .section h4:before{
      content:""; position:absolute; left:0; top:4px; bottom:4px; width:3px; background:var(--brand); border-radius:3px;
    }
    ul{margin:6px 0 0 18px}
    .muted{color:var(--muted)}
    .footer-line{border-top:1px dashed var(--line); margin-top:12px; padding-top:10px; display:flex; justify-content:flex-end; gap:10px}

    #printSandbox{display:none}
    .hide-print{}
    @media print{
      @page{ size:A4; margin:12mm; }
      body{background:#fff}
      body.printing *{ visibility:hidden !important; }
      body.printing #printSandbox,
      body.printing #printSandbox *{ visibility:visible !important; }
      body.printing #printSandbox{ display:block !important; position:absolute; left:0; top:0; width:100%; }
      body.printing .rph{ page-break-after:always; }
      body.printing .rph:last-child{page-break-after:auto}
      .hide-print{display:none !important}
    }
  </style>
</head>
<body>
<header class="hide-print">
  <h1>Sistem Rancangan Pengajaran Harian - ENGLISH</h1>
  <p>Auto-generate DLP mengikut takwim sekolah (2025)</p>
</header>

<main>
  <div class="card hide-print">
    <div class="row">
      <div>
        <label for="subject">Matapelajaran</label>
        <select id="subject">
          <option>BAHASA INGGERIS</option>
        </select>
      </div>
      <div>
        <label for="year">Tahun</label>
        <select id="year">
          <option>TAHUN 1</option><option>TAHUN 2</option><option>TAHUN 3</option>
          <option>TAHUN 4</option><option>TAHUN 5</option><option>TAHUN 6</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="flex:1 1 100%">
        <label>Jadual (Isikan Masa)</label>
        <table>
          <thead><tr><th>Hari</th><th>Masa</th></tr></thead>
          <tbody id="jadualBody"></tbody>
        </table>
      </div>
    </div>

<div class="toolbar">
  <button class="btn" id="genBtn">HASILKAN RPH</button>
  <div class="filters">
    <label for="mingguSelect">Minggu</label>
    <select id="mingguSelect" style="min-width:120px"></select>
  </div>
  <button class="btn secondary" id="printWeekBtn">Cetak Minggu Dipilih</button>
  <button class="btn ghost" id="sendBtn">HANTAR</button>
</div>

  <div id="output"></div>
</main>

<div id="printSandbox" aria-hidden="true"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const jadualBody = document.getElementById("jadualBody");
  ["Isnin","Selasa","Rabu","Khamis","Jumaat"].forEach(h=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="width:160px"><b>${h}</b></td>
                    <td><input type="text" placeholder="cth: 7:10 – 8:10" data-hari="${h}"></td>`;
    jadualBody.appendChild(tr);
  });
});

// Global variable to hold fetched data
let EN_UNITS = {};
let POOLS = {};

// Fetch data from sp-bi.json
async function loadJsonData() {
  try {
    const response = await fetch('sp-bi.json');
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    
    // Rebuild EN_UNITS and POOLS from JSON structure
    EN_UNITS = {};
    POOLS = data;

    // Build EN_UNITS as array of unit names per year
    for (const [year, unitsObj] of Object.entries(data)) {
      EN_UNITS[year] = Object.keys(unitsObj);
    }
  } catch (error) {
    console.error("Failed to load sp-bi.json:", error);
    alert("Ralat: Tidak dapat memuatkan data RPH dari sp-bi.json. Sila pastikan fail wujud.");
  }
}

// Initialize dropdown with placeholder until data loads
(function initWeekDropdown(){
  const mingguSel = document.getElementById("mingguSelect");
  mingguSel.innerHTML = "";
  for(let i=1;i<=42;i++){
    const o=document.createElement("option"); o.value=i; o.textContent="Minggu "+i;
    mingguSel.appendChild(o);
  }
})();

// Load data on startup
loadJsonData();

/* ==============================================================
   Takwim Sekolah 2025 (unchanged)
   ============================================================== */
const TAKWIM = [
  ["2025-02-17","2025-02-28"],
  ["2025-03-01","2025-03-31"],
  ["2025-04-01","2025-04-30"],
  ["2025-05-01","2025-05-28"],
  ["2025-06-10","2025-06-30"],
  ["2025-07-01","2025-07-31"],
  ["2025-08-01","2025-08-31"],
  ["2025-09-01","2025-09-12"],
  ["2025-09-22","2025-09-30"],
  ["2025-10-01","2025-10-31"],
  ["2025-11-01","2025-11-30"],
  ["2025-12-01","2025-12-19"]
];

/* =======================
   Util Tarikh & Minggu
   ======================= */
const HARI_MS = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
const HARI_EN = { "Isnin":"MONDAY","Selasa":"TUESDAY","Rabu":"WEDNESDAY","Khamis":"THURSDAY","Jumaat":"FRIDAY" };

function* workingDatesInCalendar(){
  for(const [s,e] of TAKWIM){
    let d = new Date(s), end = new Date(e);
    while(d <= end){
      const day = d.getDay();
      if(day !== 0 && day !== 6){ yield new Date(d); }
      d.setDate(d.getDate()+1);
    }
  }
}

function computeWeekNumbers(dates){
  let week=1;
  return dates.map((d,i)=>{
    if(i!==0 && d.getDay()===1) week++;
    return {date:d, week};
  });
}

function fmtDateMS(date){
  return date.toLocaleDateString("ms-MY", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
}

/* =======================
   Generate RPH (Modified)
   ======================= */
const output = document.getElementById("output");
const genBtn = document.getElementById("genBtn");
const subjectSel = document.getElementById("subject");
const yearSel = document.getElementById("year");
const mingguSel = document.getElementById("mingguSelect");

genBtn.addEventListener("click", async () => {
  // Ensure data is loaded
  if (Object.keys(POOLS).length === 0) {
    alert("Data RPH masih dimuatkan. Sila cuba sebentar lagi.");
    return;
  }

  const subject = subjectSel.value;
  const year = yearSel.value;
  if(subject !== "BAHASA INGGERIS"){
    alert("Buat masa ini, kandungan terperinci hanya untuk BAHASA INGGERIS. Sila pilih Bahasa Inggeris.");
    return;
  }

  output.innerHTML = "";

  // masa jadual
  const masaMap = {};
  document.querySelectorAll("input[data-hari]").forEach(inp => {
    const val = (inp.value || "").trim();
    if (val) {
      masaMap[inp.dataset.hari] = val;
    }
  });

  // Kumpul tarikh bekerja + minggu
  const dates = [...workingDatesInCalendar()];
  const datedWeeks = computeWeekNumbers(dates);

  // Isi dropdown minggu mengikut maksimum minggu sebenar
  const maxWeek = datedWeeks.at(-1)?.week || 1;
  mingguSel.innerHTML = "";
  for(let i=1; i<=maxWeek; i++){
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = "Minggu " + i;
    mingguSel.appendChild(opt);
  }

  // Unit mingguan ikut Tahun (berpusing jika > bil unit)
  const units = EN_UNITS[year];
  if (!units || units.length === 0) {
    alert(`Tiada unit tersedia untuk ${year}.`);
    return;
  }

  // Peta minggu → unit
  const weekToUnit = {};
  for(let w=1; w<=maxWeek; w++){
    weekToUnit[w] = units[(w-1) % units.length];
  }

  // Jana RPH untuk setiap tarikh bekerja
  datedWeeks.forEach(({date, week}) => {
    const hari = HARI_MS[date.getDay()];
    if (hari === "Ahad" || hari === "Sabtu") return;

    const masa = masaMap[hari];
    if (!masa) return;

    const weeklyTopic = weekToUnit[week];

    // Dapatkan objek unit dari POOLS
    const unitData = POOLS[year]?.[weeklyTopic];
    if (!unitData) {
      console.warn(`Tiada data untuk unit: ${weeklyTopic} dalam ${year}`);
      return;
    }

    // Dapatkan senarai kemahiran dalam unit ini
    const skillNames = Object.keys(unitData);
    if (skillNames.length < 3) {
      console.warn(`Unit ${weeklyTopic} hanya mempunyai ${skillNames.length} kemahiran. Memerlukan 3.`);
      return;
    }

    // Pilih 3 kemahiran unik secara rawak
    const selectedSkills = getRandomUniqueElements(skillNames, 3);

    // Gabungkan kandungan dari 3 kemahiran
    let combinedStandards = [];
    let combinedObjectives = [];
    let combinedActivities = [];
    let combinedAssessment = [];
    let combinedAids = [];

// Pilih 3 kemahiran unik secara rawak
const selectedSkills = getRandomUniqueElements(skillNames, 3);

// Gabungkan kandungan dari 3 kemahiran — TETAPI hanya SATU aktiviti & penilaian per kemahiran
let combinedStandards = [];
let combinedObjectives = [];
let combinedActivities = [];
let combinedAssessment = [];
let combinedAids = [];

selectedSkills.forEach(skill => {
  const skillPool = unitData[skill];
  const randomItem = skillPool[Math.floor(Math.random() * skillPool.length)];

  // Tetap gabungkan standards & objectives (ia biasanya satu string sahaja)
  combinedStandards.push(`${skill}: ${randomItem.standards}`);
  combinedObjectives.push(`${skill}: ${randomItem.objectives}`);

  // 🛠️ UNTUK ACTIVITIES: pilih SATU sahaja secara rawak dari senarai
  if (randomItem.activities && randomItem.activities.length > 0) {
    const randomActivity = randomItem.activities[Math.floor(Math.random() * randomItem.activities.length)];
    combinedActivities.push(`${skill}: ${randomActivity}`);
  }

  // 🛠️ UNTUK ASSESSMENT: pilih SATU sahaja secara rawak dari senarai
  if (randomItem.assessment && randomItem.assessment.length > 0) {
    const randomAssessment = randomItem.assessment[Math.floor(Math.random() * randomItem.assessment.length)];
    combinedAssessment.push(`${skill}: ${randomAssessment}`);
  }

  // Tetap gabungkan aids (dan buang duplikat kemudian)
  combinedAids.push(...randomItem.aids);
});

// Buang duplikat aids
combinedAids = [...new Set(combinedAids)];

    const node = renderRPH({
      subject: "English",
      yearNum: parseInt(year.replace(/\D/g, "")) || "",
      dayEN: HARI_EN[hari],
      time: masa.trim(),
      week,
      weeklyTopic,
      dateStr: fmtDateMS(date),
      standards: combinedStandards.join("; "),
      objectives: combinedObjectives.join("; "),
      activities: combinedActivities,
      assessment: combinedAssessment,
      aids: combinedAids
    });

    node.dataset.week = week;
    output.appendChild(node);
  });

  // 👇 PERBAIKAN UTAMA: Tunggu sekejap untuk pastikan DOM stabil
  setTimeout(() => {
    mingguSel.value = "1";
    filterByWeek(); // Sekarang akan berfungsi!
  }, 0);
});

// Helper: Get N random unique elements from array
function getRandomUniqueElements(arr, n) {
  const shuffled = [...arr].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, n);
}

/* =======================
   Renderer RPH (Perbaiki escapeHTML)
   ======================= */
function renderList(items){
  return `<ul>${items.map(i=>`<li>${escapeHTML(i)}</li>`).join("")}</ul>`;
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '<',   // 🛠️ DIPERBAIKI: sebelum ini hilang <
    '>': '>',   // 🛠️ DIPERBAIKI: sebelum ini hilang >
    '"': '&quot;',
    "'": '&#39;'
  }[m]));
}

function renderRPH(data){
  const wrap = document.createElement("div");
  wrap.className = "rph";
  wrap.innerHTML = `
    <div class="rph-header">
      <div class="rph-title">DAILY LESSON PLAN (DLP)</div>
      <div style="text-align:right; font-weight:700; color:#1e293b">Week: ${data.week}</div>

      <div class="kv">
        <b>Subject:</b><div>${escapeHTML(data.subject)}</div>
        <b>Year:</b><div>${escapeHTML(data.yearNum)}</div>
        <b>Day:</b><div>${escapeHTML(data.dayEN)}</div>
        <b>Time:</b><div>${escapeHTML(data.time)}</div>
      </div>
      <div class="kv">
        <b>Weekly Topic:</b><div>${escapeHTML(data.weeklyTopic)}</div>
        <b>Date:</b><div>${escapeHTML(data.dateStr)}</div>
      </div>
    </div>

    <div class="section">
      <h4>Learning Standards</h4>
      <div class="muted">${escapeHTML(data.standards)}</div>
    </div>

    <div class="section">
      <h4>Learning Objectives</h4>
      <div>${escapeHTML(data.objectives)}</div>
    </div>

    <div class="section">
      <h4>Teaching & Learning Activities</h4>
      ${renderList(data.activities)}
    </div>

    <div class="section">
      <h4>Assessment</h4>
      ${renderList(data.assessment)}
    </div>

    <div class="section">
      <h4>Teaching Aids</h4>
      ${renderList(data.aids)}
    </div>

    <div class="section">
      <h4>Reflection</h4>
      <div class="muted">………………………………………………………………………………………………………………………………………………………………</div>
    </div>

    <div class="footer-line hide-print">
      <button class="btn ghost" onclick="printNodes([this.closest('.rph')])">Cetak RPH Ini</button>
    </div>
  `;
  return wrap;
}

/* =======================
   Cetak & Tapis (Pastikan fungsi ini dipanggil selepas DOM stabil)
   ======================= */
function filterByWeek(){
  const w = parseInt(mingguSel.value || "0", 10); // 🛠️ Tambah radix 10 untuk parseInt
  const rphNodes = document.querySelectorAll(".rph");
  if (rphNodes.length === 0) return; // 🛡️ Jika tiada RPH, jangan buat apa-apa

  rphNodes.forEach(node => {
    const nodeWeek = parseInt(node.dataset.week, 10);
    node.style.display = (nodeWeek === w) ? "" : "none";
  });
}

function printNodes(nodes){
  if(!nodes || nodes.length === 0){
    alert("Tiada RPH untuk dicetak.");
    return;
  }

  const sand = document.getElementById("printSandbox");
  sand.innerHTML = "";

  const seen = new Set();
  nodes.forEach(n => {
    const selectors = [
      n.querySelector(".kv b + div")?.textContent,           // Subject
      n.querySelector(".kv b + div + b + div")?.textContent, // Year
      n.querySelectorAll(".kv b + div")[2]?.textContent,     // Day
      n.querySelectorAll(".kv b + div")[3]?.textContent,     // Time
      n.querySelectorAll(".kv b + div")[5]?.textContent      // Date
    ];
    const key = [n.dataset.week, ...selectors].join("|");

    if(!seen.has(key)){
      const clone = n.cloneNode(true);
      const btn = clone.querySelector(".footer-line");
      if(btn) btn.remove();
      clone.style.display = "";
      sand.appendChild(clone);
      seen.add(key);
    }
  });

  document.body.classList.add("printing");

  const cleanup = () => {
    document.body.classList.remove("printing");
    sand.innerHTML = "";
  };

  const onAfter = () => {
    cleanup();
    window.removeEventListener("afterprint", onAfter);
  };
  window.addEventListener("afterprint", onAfter, { once: true });

  window.print();

  setTimeout(() => {
    if(document.body.classList.contains("printing")) cleanup();
  }, 1500);
}

// 👇 PASANG EVENT LISTENER UNTUK DROPDOWN MINGGU — PEMBAIKAN UTAMA
mingguSel.addEventListener("change", filterByWeek);

// 👇 Event listener untuk "Cetak Minggu Dipilih"
document.getElementById("printWeekBtn").addEventListener("click", () => {
  const selectedWeek = parseInt(mingguSel.value, 10);
  const nodesToPrint = Array.from(document.querySelectorAll(".rph"))
    .filter(node => parseInt(node.dataset.week, 10) === selectedWeek);
  if (nodesToPrint.length === 0) {
    alert("Tiada RPH untuk minggu ini.");
    return;
  }
  printNodes(nodesToPrint);
});

document.getElementById("sendBtn").addEventListener("click", () => {
  window.open("https://script.google.com/a/macros/moe-dl.edu.my/s/AKfycbz_5pyWVWYRalnUElx8v4dRZ2pPTiC7dsXc8l77UqpMUcYZ736Ul-0ykUNEhtgnS8A/exec  ", "_blank");
});
</script>
</body>
</html>
