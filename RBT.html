<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem RPH — Reka Bentuk Teknologi (Print-Safe)</title>
  <style>
    :root{
      --brand:#1d4ed8;
      --brand-light:#60a5fa;
      --ink:#111827;
      --muted:#6b7280;
      --panel:#ffffff;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      margin:0; background:#f3f4f6; color:var(--ink);
      line-height:1.6;
    }
    header{
      background:linear-gradient(135deg,#006400,#228B22,var(--brand),var(--brand-light));
      color:#fff; padding:28px 16px; text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    header h1{margin:0 0 6px;font-weight:700;font-size:1.8rem}
    header p{margin:0;opacity:.95;font-size:1rem}
    main{max-width:1100px;margin:20px auto;padding:0 16px 50px}
    .card{
      background:var(--panel); border:1px solid var(--line);
      border-radius:14px; padding:22px;
      box-shadow:0 6px 24px rgba(0,0,0,.06);
    }
    .row{display:flex;flex-wrap:wrap;gap:16px}
    .row > *{flex:1 1 220px}
    label{font-weight:600;color:var(--muted);font-size:.95rem;display:block;margin-bottom:4px}
    select, input[type="text"]{
      width:100%; padding:10px 12px; border:1px solid var(--line);
      border-radius:10px; background:#fff; font-size:14px;
      transition:border-color .2s, box-shadow .2s;
    }
    select:focus, input[type="text"]:focus{
      border-color:var(--brand); box-shadow:0 0 0 2px rgba(29,78,216,.15);
      outline:none;
    }
    table{
      width:100%; border-collapse:collapse; margin-top:10px; background:#fff;
      border:1px solid var(--line); border-radius:10px; overflow:hidden;
    }
    th, td{padding:10px 12px; border-bottom:1px solid var(--line); text-align:left}
    th{background:#f9fafb;font-weight:700;color:var(--ink)}
    tr:last-child td{border-bottom:none}
    .btn{
      display:inline-block; padding:10px 16px; border-radius:10px; border:1px solid transparent;
      background:var(--brand); color:#fff; cursor:pointer; font-weight:600;
      box-shadow:0 4px 12px rgba(29,78,216,.3); transition:.15s;
    }
    .btn.secondary{background:#0284c7}
    .btn.ghost{background:#fff;color:var(--brand);border-color:var(--brand);box-shadow:none}
    .btn:hover{transform:translateY(-1px);}
    .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:14px}
    #output{margin-top:22px}

    .rph{
      background:#fff; border:1px solid var(--line); border-radius:14px;
      padding:22px 22px 16px; margin:18px 0; box-shadow:0 4px 14px rgba(0,0,0,.06);
      page-break-after:always;
    }
    .rph-header{
      display:grid; grid-template-columns:1fr 1fr; gap:8px 16px; align-items:center;
      border-bottom:2px solid var(--line); padding-bottom:12px; margin-bottom:12px;
    }
    .rph-title{font-size:1.15rem; font-weight:800; letter-spacing:.3px;color:var(--brand)}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:2px 10px; font-size:.94rem}
    .kv b{color:var(--ink)}
    .section{margin-top:12px;}
    .section h4{
      margin:12px 0 6px; font-size:1rem; color:var(--ink); position:relative; padding-left:12px;
    }
    .section h4:before{
      content:""; position:absolute; left:0; top:4px; bottom:4px; width:3px; background:var(--brand); border-radius:3px;
    }
    ul{margin:6px 0 0 18px}
    .muted{color:var(--muted)}
    .footer-line{border-top:1px dashed var(--line); margin-top:12px; padding-top:10px; display:flex; justify-content:flex-end; gap:10px}

    #printSandbox{display:none}
    .hide-print{}
    @media print{
      @page{ size:A4; margin:12mm; }
      body{background:#fff}
      body.printing *{ visibility:hidden !important; }
      body.printing #printSandbox,
      body.printing #printSandbox *{ visibility:visible !important; }
      body.printing #printSandbox{ display:block !important; position:absolute; left:0; top:0; width:100%; }
      body.printing .rph{ page-break-after:always; }
      body.printing .rph:last-child{page-break-after:auto}
      .hide-print{display:none !important}
    }
  </style>
</head>
<body>
<header class="hide-print">
  <h1>Sistem Rancangan Pengajaran Harian - REKA BENTUK TEKNOLOGI</h1>
  <p>Auto-generate DLP mengikut takwim sekolah (2025)</p>
</header>

<main>
  <div class="card hide-print">
    <div class="row">
      <div>
        <label for="subject">Matapelajaran</label>
        <select id="subject">
          <option>RBT</option>
        </select>
      </div>
      <div>
        <label for="year">Tahun</label>
        <select id="year">
          <option>TAHUN 4</option><option>TAHUN 5</option><option>TAHUN 6</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="flex:1 1 100%">
        <label>Jadual (Isikan Masa)</label>
        <table>
          <thead><tr><th>Hari</th><th>Masa</th></tr></thead>
          <tbody id="jadualBody"></tbody>
        </table>
      </div>
    </div>

<div class="toolbar">
  <button class="btn" id="genBtn">HASILKAN RPH</button>
  <div class="filters">
    <label for="mingguSelect">Minggu</label>
    <select id="mingguSelect" style="min-width:120px"></select>
  </div>
  <button class="btn secondary" id="printWeekBtn">Cetak Minggu Dipilih</button>
  <button class="btn ghost" id="sendBtn">HANTAR</button>
</div>

  <div id="output"></div>
</main>

<div id="printSandbox" aria-hidden="true"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const jadualBody = document.getElementById("jadualBody");
  ["Isnin","Selasa","Rabu","Khamis","Jumaat"].forEach(h=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="width:160px"><b>${h}</b></td>
                    <td><input type="text" placeholder="cth: 7:10 – 8:10" data-hari="${h}"></td>`;
    jadualBody.appendChild(tr);
  });
});

/* =======================
   1) Data: Unit Mingguan
   ======================= */
const RBT_UNITS = {
  "TAHUN 4": [
    "Unit 1: Reka Bentuk Pengaturcaraan",
    "Unit 2: Pengenalan Kod Blok (Scratch)",
    "Unit 3: Projek Animasi Mudah",
    "Unit 4: Projek Interaktif"
  ],
  "TAHUN 5": [
    "Unit 1: Pengenalan Asas Sistem Robotik",
    "Unit 2: Pengenalan Komponen Robot",
    "Unit 3: Kawalan Robot dengan Kod Blok",
    "Unit 4: Projek Robot Mini"
  ],
  "TAHUN 6": [
    "Unit 1: Pembangunan Produk",
    "Unit 2: Penghasilan Produk",
    "Unit 3: Ujian & Penambahbaikan",
    "Unit 4: Persembahan Produk Akhir"
  ]
};

/* ==============================================================
   2) RBT_POLLS kandungan berbeza bagi setiap Tahun (variasi dijamin)
   ============================================================== */
const RBT_POLLS = {
  "TAHUN 4": [
    {
      standards:"4.1 menggunakan pengaturcaraan blok; 4.2 menghasilkan animasi mudah.",
      objectives:"Murid dapat menulis kod blok asas untuk menggerakkan objek.",
      activities:["Demo Scratch: gerakkan kucing","Murid buat animasi sendiri","Persembahan hasil animasi"],
      assessment:["Rubrik animasi","Refleksi murid"],
      aids:["Komputer/laptop","Perisian Scratch","Projector"]
    }
  ],
  "TAHUN 5": [
    {
      standards:"5.1 mengenal komponen robot; 5.2 mengawal robot menggunakan kod blok.",
      objectives:"Murid dapat memasang robot mini dan mengawal pergerakannya.",
      activities:["Pengenalan kit robotik","Aktiviti pasang robot","Programkan robot bergerak ke arah sasaran"],
      assessment:["Senarai semak pemasangan","Ujian praktikal kawalan robot"],
      aids:["Kit robot mini","Laptop/Tablet","Perisian kawalan robot"]
    }
  ],
  "TAHUN 6": [
    {
      standards:"6.1 membangunkan produk; 6.2 menguji dan menambah baik produk.",
      objectives:"Murid dapat menghasilkan produk kreatif dan mempersembahkan kepada kelas.",
      activities:["Brainstorm idea produk","Membuat prototaip","Menguji dan menambah baik produk","Persembahan akhir produk"],
      assessment:["Rubrik produk","Refleksi kumpulan","Laporan projek"],
      aids:["Bahan projek (kayu, plastik, elektronik)","Alatan bengkel","Borang rubrik"]
    }
  ]
};

/* =======================
   3) Takwim Sekolah 2025
   ======================= */
const TAKWIM = [
  ["2025-02-17","2025-02-28"],
  ["2025-03-01","2025-03-31"],
  ["2025-04-01","2025-04-30"],
  ["2025-05-01","2025-05-28"],
  ["2025-06-10","2025-06-30"],
  ["2025-07-01","2025-07-31"],
  ["2025-08-01","2025-08-31"],
  ["2025-09-01","2025-09-12"],
  ["2025-09-22","2025-09-30"],
  ["2025-10-01","2025-10-31"],
  ["2025-11-01","2025-11-30"],
  ["2025-12-01","2025-12-19"]
];

/* =======================
   4) Util Tarikh & Minggu
   ======================= */
const HARI_MS = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
const HARI_EN = { "Isnin":"MONDAY","Selasa":"TUESDAY","Rabu":"WEDNESDAY","Khamis":"THURSDAY","Jumaat":"FRIDAY" };

function* workingDatesInCalendar(){
  for(const [s,e] of TAKWIM){
    let d = new Date(s), end = new Date(e);
    while(d <= end){
      const day = d.getDay(); // 0 Ahad .. 6 Sabtu
      if(day !== 0 && day !== 6){ yield new Date(d); }
      d.setDate(d.getDate()+1);
    }
  }
}

// kira nombor minggu bermula 17/2/2025; minggu bertambah setiap ISNIN baru
function computeWeekNumbers(dates){
  let week=1;
  return dates.map((d,i)=>{
    if(i!==0 && d.getDay()===1) week++; // setiap Isnin
    return {date:d, week};
  });
}

function fmtDateMS(date){
  return date.toLocaleDateString("ms-MY", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
}


/* =======================
   6) Generate RPH
   ======================= */
const output = document.getElementById("output");
const genBtn = document.getElementById("genBtn");
const subjectSel = document.getElementById("subject");
const yearSel = document.getElementById("year");
const mingguSel = document.getElementById("mingguSelect");

genBtn.addEventListener("click", generateRPH);

document.getElementById("printWeekBtn").addEventListener("click", () => {
  const w = parseInt(mingguSel.value || "0");
  const nodes = [...document.querySelectorAll(`.rph[data-week='${w}']`)];
  printNodes(nodes);
});
mingguSel.addEventListener("change", filterByWeek);

function generateRPH(){
  const subject = subjectSel.value;
  const year = yearSel.value;
  if(subject !== "RBT"){
    alert("Buat masa ini, kandungan terperinci hanya untuk RBT. Sila pilih RBT.");
    return;
  }

  output.innerHTML = "";
// masa jadual
const masaMap = {};
document.querySelectorAll("input[data-hari]").forEach(inp => {
  if (inp.value && inp.value.trim() !== "") {
    masaMap[inp.dataset.hari] = inp.value.trim();
  }
});

  // Kumpul tarikh bekerja + minggu
  const dates = [...workingDatesInCalendar()];
  const datedWeeks = computeWeekNumbers(dates);

  // Isi dropdown minggu mengikut maksimum minggu sebenar
  const maxWeek = datedWeeks.at(-1).week;
  mingguSel.innerHTML = "";
  for(let i=1;i<=maxWeek;i++){
    const opt=document.createElement("option"); opt.value=i; opt.textContent="Minggu "+i;
    mingguSel.appendChild(opt);
  }

  // Unit mingguan ikut Tahun (berpusing jika > bil unit)
  const units = RBT_UNITS[year];
  const pool = RBT_POLLS[year];

  // Peta minggu → unit
  const weekToUnit = {};
  for(let w=1; w<=maxWeek; w++){
    weekToUnit[w] = units[(w-1) % units.length];
  }

// Jana RPH untuk setiap tarikh bekerja
datedWeeks.forEach(({date,week}) => {
  const hari = HARI_MS[date.getDay()];
  if(hari==="Ahad"||hari==="Sabtu") return;

  // Semak jadual masa
const masa = masaMap[hari];
if(!masa) return; // <-- Skip terus kalau hari itu tiada masa

  const weeklyTopic = weekToUnit[week];
  const variant = pool[(week + date.getDay()) % pool.length];

  const node = renderRPH({
    subject:"RBT",
    yearNum: parseInt(year.replace(/\D/g,"")) || "",
    dayEN: HARI_EN[hari],
    time: masa,
    week,
    weeklyTopic,
    dateStr: fmtDateMS(date),
    ...variant
  });

  node.dataset.week = week;
  output.appendChild(node);
});


  // Selepas jana, tapis ikut minggu = 1
  mingguSel.value = "1";
  filterByWeek();
}

/* =======================
   7) Renderer RPH (DLP)
   ======================= */
function renderList(items){
  return `<ul>${items.map(i=>`<li>${escapeHTML(i)}</li>`).join("")}</ul>`;
}
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function renderRPH(data){
  const wrap = document.createElement("div");
  wrap.className = "rph";
  wrap.innerHTML = `
    <div class="rph-header">
      <div class="rph-title">DAILY LESSON PLAN (DLP)</div>
      <div style="text-align:right; font-weight:700; color:#1e293b">Week: ${data.week}</div>

      <div class="kv">
        <b>Subject:</b><div>${escapeHTML(data.subject)}</div>
        <b>Year:</b><div>${escapeHTML(data.yearNum)}</div>
        <b>Day:</b><div>${escapeHTML(data.dayEN)}</div>
        <b>Time:</b><div>${escapeHTML(data.time)}</div>
      </div>
      <div class="kv">
        <b>Weekly Topic:</b><div>${escapeHTML(data.weeklyTopic)}</div>
        <b>Date:</b><div>${escapeHTML(data.dateStr)}</div>
      </div>
    </div>

    <div class="section">
      <h4>Learning Standards</h4>
      <div class="muted">${escapeHTML(data.standards)}</div>
    </div>

    <div class="section">
      <h4>Learning Objectives</h4>
      <div>${escapeHTML(data.objectives)}</div>
    </div>

    <div class="section">
      <h4>Teaching & Learning Activities</h4>
      ${renderList(data.activities)}
    </div>

    <div class="section">
      <h4>Assessment</h4>
      ${renderList(data.assessment)}
    </div>

    <div class="section">
      <h4>Teaching Aids</h4>
      ${renderList(data.aids)}
    </div>

    <div class="section">
      <h4>Reflection</h4>
      <div class="muted">………………………………………………………………………………………………………………………………………………………………</div>
    </div>

    <div class="footer-line hide-print">
      <button class="btn ghost" onclick="printNodes([this.closest('.rph')])">Cetak RPH Ini</button>
    </div>
  `;
  return wrap;
}

/* =======================
   8) Cetak & Tapis
   ======================= */
function filterByWeek(){
  const w = parseInt(mingguSel.value || "0");
  document.querySelectorAll(".rph").forEach(node=>{
    node.style.display = (parseInt(node.dataset.week)===w) ? "" : "none";
  });
}

/** 
 * Print sandbox tanpa duplikasi
 * - hanya salinan dalam #printSandbox akan dicetak
 * - semua UI lain disembunyikan dengan kelas body.printing
 */
function printNodes(nodes){
  if(!nodes||nodes.length===0){alert("Tiada RPH untuk dicetak.");return;}

  const sand = document.getElementById("printSandbox");
  sand.innerHTML = ""; // bersihkan terlebih dahulu

  // dedupe berdasarkan gabungan minggu + tarikh + hari + masa
  const seen = new Set();
  nodes.forEach(n=>{
    const key = [
      n.dataset.week,
      n.querySelector(".kv b + div")?.textContent, // Subject
      n.querySelector(".kv b + div + b + div")?.textContent, // Year
      n.querySelectorAll(".kv b + div")[2]?.textContent, // Day
      n.querySelectorAll(".kv b + div")[3]?.textContent, // Time
      n.querySelectorAll(".kv b + div")[5]?.textContent  // Date
    ].join("|");

    if(!seen.has(key)){
      const clone = n.cloneNode(true);
      // buang butang cetak per-item
      const btn = clone.querySelector(".footer-line");
      if(btn) btn.remove();
      clone.style.display = "";
      sand.appendChild(clone);
      seen.add(key);
    }
  });

  // aktifkan mod printing
  document.body.classList.add("printing");

  const cleanup = () => {
    document.body.classList.remove("printing");
    sand.innerHTML = "";
  };

  // cuba gunakan afterprint, dengan fallback timeout
  const onAfter = () => { cleanup(); window.removeEventListener("afterprint", onAfter); };
  window.addEventListener("afterprint", onAfter, { once:true });

  // cetak
  window.print();

  // Fallback (sekiranya afterprint tidak terpicu)
  setTimeout(()=>{
    if(document.body.classList.contains("printing")) cleanup();
  }, 1500);
}

// Butang HANTAR → buka pautan Google Apps Script
document.getElementById("sendBtn").addEventListener("click", () => {
  window.open("https://script.google.com/a/macros/moe-dl.edu.my/s/AKfycbz_5pyWVWYRalnUElx8v4dRZ2pPTiC7dsXc8l77UqpMUcYZ736Ul-0ykUNEhtgnS8A/exec", "_blank");
});

/* Auto isi dropdown minggu kosong pada mula (default 42) */
(function initWeekDropdown(){
  mingguSel.innerHTML = "";
  for(let i=1;i<=42;i++){
    const o=document.createElement("option"); o.value=i; o.textContent="Minggu "+i;
    mingguSel.appendChild(o);
  }
})();
</script>
</body>
</html>